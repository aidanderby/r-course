---
title: "Examples of `ggplot2` graphics"
author: "Will Drysdale & Jack Davison"
date: "12/11/2021"
output:
  rmdformats::downcute:
    highlight: tango
    number_sections: false
    lightbox: false
    gallery: true
    cards: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c("top", "right"), color = "white")
```

# Introduction

This document acts as a reference for different kinds of plots in `ggplot2`. Note that, in `ggplot2` there is no "scatter plot" or "line plot" or "box plot" function - you layer on different *geometries* to construct whatever combinations of plot you can think of.

The data used in this document is the same as the data used in the taught portion of the course. It can be prepared using the script from Day 2, or using the below code:

```{r}

library(tidyverse)
library(openair)

sites = list.files(path = "C:/Users/jd6th/Documents/course_data/data_taught/data_day_2/", pattern = ".csv") %>% 
  str_remove("_2018.csv")

files = list.files(path = "C:/Users/jd6th/Documents/course_data/data_taught/data_day_2/", pattern = ".csv",full.names = T)

df_raw = data.frame()

for(i in 1:length(sites)){
  
  j = read.csv(file = files[[i]], na.strings = c("NA", "missing")) %>% 
    tibble() %>%
    mutate(site = sites[[i]])
  
  df_raw = rbind(df_raw, j)
  
}

df = df_raw %>%
  select(-X) %>%
  mutate(date = lubridate::ymd_hms(date),
         nox = no + no2)

df_long = df %>% pivot_longer(-c(site, date), names_to = "species", values_to = "conc")

rm(df_raw, j, files, i, sites)

```

# Plots

## Line Chart

A line chart, coloured by pollutant and split by site.

```{r}
df_daily_long = df %>%
  timeAverage(avg.time = "day", type = "site") %>%
  pivot_longer(-c(site, date), names_to = "species", values_to = "conc")

df_daily_long %>%
  ggplot() +
  aes(x = date, y = conc, color = site) +
  geom_line() +
  facet_grid(species~., scales = "free_y") +
  theme_bw() +
  theme(legend.position = "top") +
  labs(x = "Date", y = "Concentration (ppb)", color = "Site") # good theming
```

## Bar Chart

Bar chart showing pollutants at different sites, plotting the median and interquartile range.

```{r}
df_long %>%
  group_by(site, species) %>%
  summarise(median = median(conc, na.rm = T),
            q25 = quantile(conc, .25, na.rm = T),
            q75 = quantile(conc, .75, na.rm = T)) %>%
  ggplot(aes(x = site, y = median)) +
  geom_col(aes(fill = site), position = position_dodge2()) +
  geom_pointrange(aes(ymax = q75, ymin = q25)) +
  theme_bw() +
  facet_wrap(~species, scales = "free_y") +
  labs(x = "Site Code", y = "Mean (+/- SD) Concentration (ppb)")
```

## Function Plots

A scatter plot showing two models - one smoothed function (a "GAM") and one linear model. The euqation of the linear model is annotated.

```{r}
coefs = lm(nox ~ no2, df) %>%
  coef() %>%
  signif(3)

equation = paste0("NOX = ", coefs[1], " + ", coefs[2], " NO2")

df %>%
  ggplot(aes(x = no2, y = nox)) +
  geom_point(alpha = .05) +
  geom_smooth(method = "lm", color = "red") +
  geom_smooth(color = "blue") +
  annotate(y = 200, x = 150, geom = "text", label = equation, color = "red") +
  labs(x = quickText("NO2 (ppb)"), y = quickText("NOx")) +
  theme_bw()

```

## Density Plots

A density plot of NOx at different sites, including a vertical line showing the mean for each, on a log scale.

```{r}
df %>%
  group_by(site) %>%
  mutate(mean = mean(nox, na.rm = T)) %>%
  ggplot(aes(color = site)) +
  geom_density(aes(x = nox)) +
  geom_vline(aes(xintercept = mean, color = site), lty = 3, size = 1) +
  scale_x_log10() +
  theme_bw() +
  labs(x = quickText("NOx (ppb)"), color = "Site Code") +
  theme(legend.position = "top")
```

